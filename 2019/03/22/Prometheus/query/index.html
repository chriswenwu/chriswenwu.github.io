<!DOCTYPE html>
<html>
  <head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#33363b">
    <meta name="msapplication-TileColor" content="#33363b">
    
    
    
    
    <meta name="keywords" content="Life, ARIA, Hexo">
    
    
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
    
    
    <link rel="icon" type="image/png" sizes="192x192" href="/favicons/android-chrome-192x192.png">
    
    
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    
    
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
    
    
    <link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#33363b">
    
    
    <link rel="manifest" href="/favicons/site.webmanifest">
    
    
    <meta name="msapplication-config" content="/favicons/browserconfig.xml">
    
    
    <link rel="alternate" href="/atom.xml" title="文成武略" type="application/atom+xml">
    
    
    <link rel="shortcut icon" type="image/x-icon" href="/favicons/favicon.ico">
    
    
    <link rel="stylesheet" type="text/css" href="/css/normalize.css">
    <link rel="stylesheet" type="text/css" href="/css/index.css">
    
    <link rel="stylesheet" type="text/css" href="/css/sidebar.css">
    
    
<link rel="stylesheet" type="text/css" href="/css/page.css">
<link rel="stylesheet" type="text/css" href="/css/post.css">

    <link rel="stylesheet" type="text/css" href="/css/custom.css">
    <link rel="stylesheet" type="text/css" href="/css/atom-one-dark.css">
    <link rel="stylesheet" type="text/css" href="/css/lightgallery.min.css">
    <script type="text/javascript" src="/js/jquery.min.js"></script>
    <script defer type="text/javascript" src="/js/util.js"></script>
    <script defer type="text/javascript" src="/js/clipboard.min.js"></script>
    <script defer type="text/javascript" src="/js/scrollspy.js"></script>
    <script defer type="text/javascript" src="/js/fontawesome-all.min.js"></script>
    <script defer type="text/javascript" src="/js/lightgallery.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-fullscreen.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-hash.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-pager.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-thumbnail.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-zoom.min.js"></script>
    
    <script defer src="/js/busuanzi.pure.mini.js"></script>
    
    
    <script defer type="text/javascript" src="/js/search.js"></script>
    <script type="text/javascript">
    $(document).ready(function () {
      var searchPath = "search.xml";
      if (searchPath.length === 0) {
        searchPath = "search.xml";
      }
      var path = "/" + searchPath;
      searchFunc(path, "search-input", "search-result");
    });
    </script>
    
    
    <script defer type="text/javascript" src="/js/index.js"></script>
    <script type="text/javascript">
    $(document).ready(function () {
      var cb = null;
      var els = $(".post figure.highlight");
      if (els.length) {
        // Enabled Hexo highlight line number.
        $(els).each(function (i, e) {
          $(e).before("<button class=\"copy button\">复制</button>");
        });
        cb = new ClipboardJS("button.copy", {
          "target": function (trigger) {
              // Get target element by DOM API.
              // nextElementSibling is figure,highlight.
              // And following is the sequence of Hexo's internal
              // highlight layout with line number.
              return trigger.nextElementSibling.firstChild.firstChild.firstChild.lastChild.firstChild.firstChild;
          }
        });
      } else {
        // Disabled Hexo highlight line number.
        els = $(".post pre code");
        $(els).each(function (i, e) {
          // Add button before pre, not code.
          $(e).parent().before("<button class=\"copy button\">复制</button>");
        });
        cb = new ClipboardJS("button.copy", {
          "target": function (trigger) {
              // Get target element by DOM API.
              // nextElementSibling is figure,highlight.
              // And following is the sequence of Hexo's internal
              // highlight layout without line number.
              return trigger.nextElementSibling.firstChild;
          }
        });
      }
      cb.on("success", function (e) {
        e.clearSelection();
        var trigger = e.trigger;
        // Change button text as a user tip.
        trigger.innerHTML = "已复制";
        $(trigger).addClass("copied");
        // Change button text back;
        setTimeout(function () {
          trigger.innerHTML = "复制";
          $(trigger).removeClass("copied");
        }, 1500);
      });
    });
    </script>
    
    <script defer type="text/javascript" src="/js/custom.js"></script>
    <title>Prometheus 查询语言 | 文成武略</title>
  </head>
  <body itemscope itemtype="http://schema.org/WebPage" lang="zh_CN" data-spy="scroll" data-target=".list-group">
    
<header id="header" class="header" style="background: #33363b;">
  <div class="container">
    <div class="header-container">
      <div class="header-title">
        <h1 class="title"><a href="/">文成武略</a></h1>
        <h2 class="subtitle"></h2>
      </div>
      
      <div class="logo">
        <img src="/images/logo.png" alt="logo">
      </div>
      
    </div>
    <nav id="nav" class="nav">
      <a id="nav-toggle" class="nav-toggle" aria-hidden="true"><i class="fas fa-bars" aria-label="切换导航栏"></i></a>
      <ul id="menu" role="menubar" aria-hidden="false">
        
        <li role="menuitem"><a href="/"><i class="fas fa-home"></i><span class="menu-text">首页</span></a></li>
        
        <li role="menuitem"><a href="/archives/"><i class="fas fa-archive"></i><span class="menu-text">归档</span></a></li>
        
        <li role="menuitem"><a href="/categories/"><i class="fas fa-th-list"></i><span class="menu-text">分类</span></a></li>
        
        <li role="menuitem"><a href="/tags/"><i class="fas fa-tags"></i><span class="menu-text">标签</span></a></li>
        
        <li role="menuitem"><a href="/about/"><i class="fas fa-user-edit"></i><span class="menu-text">关于</span></a></li>
        
      </ul>
    </nav>
  </div>
</header>


    <main id="main" class="main">
      <div class="container">
        <div class="main-container">
          <div class="content">
            
<div id="post" class="page">
  
  <article class="article post card animate" itemscope itemtype="http://schema.org/Article">
    <div class="post-block">
      <link itemprop="mainEntityOfPage" href="chriswenwu.github.io/2019/03/22/Prometheus/query/">
      <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
       <meta itemprop="name" content="Chris">
       <meta itemprop="description" content>
       <meta itemprop="image" content="/images/avatar.png">
      </span>
      <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
       <meta itemprop="name" content="文成武略">
      </span>
    </div>
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">Prometheus 查询语言</h1>
      <div class="post-meta">
        
        <span class="post-date">
          <i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2019-03-22T10:10:11+08:00">2019-03-22 10:10:11</time></span>
        </span>
        
        
        
        <span class="post-meta-divider divider">|</span>
        
        <span class="post-categories">
          
          <i class="far fa-folder-open"></i><span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/运维/" itemprop="url" rel="index"><span itemprop="name">运维</span></a></span><i class="fas fa-angle-right"></i><span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/运维/监控/" itemprop="url" rel="index"><span itemprop="name">监控</span></a></span><i class="fas fa-angle-right"></i><span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/运维/监控/Prometheus/" itemprop="url" rel="index"><span itemprop="name">Prometheus</span></a></span><i class="fas fa-angle-right"></i><span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/运维/监控/Prometheus/PromQL查询/" itemprop="url" rel="index"><span itemprop="name">PromQL查询</span></a></span>
        </span>
        
        
      </div>
    </header>
    <main class="post-main" itemprop="articleBody">
      <h2 id="PromQL-语法"><a href="#PromQL-语法" class="headerlink" title="PromQL 语法"></a>PromQL 语法</h2><h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><p>PromQL 表达式计算出来的值有以下几种类型：</p>
<h3 id="瞬时向量-Instant-vector"><a href="#瞬时向量-Instant-vector" class="headerlink" title="瞬时向量 (Instant vector):"></a>瞬时向量 (Instant vector):</h3><ul>
<li>一组时序，每个时序只有一个采样值</li>
<li>区间向量 (Range vector): 一组时序，每个时序包含一段时间内的多个采样值</li>
<li>标量数据 (Scalar): 一个浮点数</li>
<li>字符串 (String): 一个字符串，暂时未用<a id="more"></a>
<h3 id="时序选择器"><a href="#时序选择器" class="headerlink" title="时序选择器"></a>时序选择器</h3></li>
</ul>
<h3 id="瞬时向量选择器"><a href="#瞬时向量选择器" class="headerlink" title="瞬时向量选择器"></a>瞬时向量选择器</h3><p>瞬时向量选择器用来选择一组时序在某个采样点的采样值。<br>最简单的情况就是指定一个度量指标，选择出所有属于该度量指标的时序的当前采样值。比如下面的表达式：</p>
<figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">http_requests_total<br></code></pre></td></tr></table></figure>
<p> 可以通过在后面添加用大括号包围起来的一组标签键值对来对时序进行过滤。比如下面的表达式筛选出了 job  为 prometheus，并且 group 为 canary 的时序：</p>
 <figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">http_requests_total&#123;job=<span class="hljs-string">"prometheus"</span>, group=<span class="hljs-string">"canary"</span>&#125;<br></code></pre></td></tr></table></figure>
<p>匹配标签 值时可以是等于，也可以使用正则表达式。总共有下面几种匹配操作符：</p>
<ul>
<li>=：完全相等</li>
<li>!=: 不相等</li>
<li>=~: 正则表达式匹配</li>
<li>!~: 正则表达式不匹配<br>下面的表达式筛选出了 environment 为 staging 或 testing 或 development，并且 method 不是 GET 的时序：</li>
</ul>
<figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">http_requests_total&#123;environment=~<span class="hljs-string">"staging|testing|development"</span>,method!=<span class="hljs-string">"GET"</span>&#125;<br></code></pre></td></tr></table></figure>
<p>度量指标名可以使用内部标签 <strong>name</strong> 来匹配，表达式 http_requests_total 也可以写成 {<strong>name</strong>=”http_requests_total”}。表达式 {<strong>name</strong>=~”job:.*”} </p>
<p>匹配所有度量指标名称以 job: 打头的时序。</p>
<h3 id="区间向量选择器"><a href="#区间向量选择器" class="headerlink" title="区间向量选择器"></a>区间向量选择器</h3><p>区间向量选择器类似于瞬时向量选择器，不同的是它选择的是过去一段时间的采样值。可以通过在瞬时向量选择器后面添加包含在 [] 里的时长来得到区间向量选择器。<br>比如下面的表达式选出了所有度量指标为 http_requests_total 且 job 为 prometheus 的时序在过去 5 分钟的采样值。</p>
<figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">http_requests_total&#123;job=<span class="hljs-string">"prometheus"</span>&#125;[5m]<br></code></pre></td></tr></table></figure>
<p>时长的单位可以是下面几种之一：</p>
<ul>
<li>s：seconds</li>
<li>m：minutes</li>
<li>h：hours</li>
<li>d：days</li>
<li>w：weeks</li>
<li>y：years</li>
</ul>
<h3 id="偏移修饰器"><a href="#偏移修饰器" class="headerlink" title="偏移修饰器"></a>偏移修饰器</h3><p>前面介绍的选择器默认都是以当前时间为基准时间，偏移修饰器用来调整基准时间，使其往前偏移一段时间。<br>偏移修饰器紧跟在选择器后面，使用 offset 来指定要偏移的量。</p>
<p>比如下面的表达式选择度量名称为 http_requests_total 的所有时序在 5 分钟前的采样值。</p>
<figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">http_requests_total offset 5m<br></code></pre></td></tr></table></figure>
<p>下面的表达式选择 http_requests_total 度量指标在 1 周前的这个时间点过去 5 分钟的采样值。</p>
<figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">http_requests_total[5m] offset 1w<br></code></pre></td></tr></table></figure>
<h2 id="PromQL-操作符"><a href="#PromQL-操作符" class="headerlink" title="PromQL 操作符"></a>PromQL 操作符</h2><h3 id="二元操作符"><a href="#二元操作符" class="headerlink" title="二元操作符"></a>二元操作符</h3><p>PromQL 的二元操作符支持基本的逻辑和算术运算，包含算术类、比较类和逻辑类 三大类。</p>
<h3 id="算术类二元操作符"><a href="#算术类二元操作符" class="headerlink" title="算术类二元操作符"></a>算术类二元操作符</h3><p>算术类二元操作符有以下几种：</p>
<ul>
<li>+：加</li>
<li>-：减</li>
<li>*：乘</li>
<li>/：除</li>
<li>%：求余</li>
<li>^：乘方</li>
</ul>
<p>算术类二元操作符可以 使用在标量与标量、向量与标量，以及向量与向量之间。</p>
<p>二元操作符上下文里的向量特指瞬时向量，不包括区间向量。</p>
<p>标量与标量之间，结果很明显，跟通常的算术运算一致。<br>向量与标量之间，相当于把标量跟向量里的每一个标量进行运算，这些 计算结果组成了一个新的向量。</p>
<p>向量与向量之间，会稍微麻烦一些。<br> 运算的时候 首先会为左边向量里的每一个元素在右边向量里去寻找一个匹配元素（匹配规则后面会讲），然后 对这两个匹配元素执行计算，这样每对匹配元素的计算结果组成了一个新的向量。<br>如果没有找到匹配元素，则该元素丢弃。</p>
<h3 id="比较类二元操作符"><a href="#比较类二元操作符" class="headerlink" title="比较类二元操作符"></a>比较类二元操作符</h3><p>比较类二元操作符有以下几种：</p>
<ul>
<li>== (equal)</li>
<li>!= (not-equal)</li>
<li><blockquote>
<p>(greater-than)</p>
</blockquote>
</li>
<li>&lt; (less-than)</li>
<li><blockquote>
<p>= (greater-or-equal)</p>
</blockquote>
</li>
<li>&lt;= (less-or-equal)</li>
</ul>
<p>比较类二元操作符同样可以 使用在标量与标量、向量与标量，以及向量与向量之间。<br>默认执行的是过滤，也就是保留值。可以通过在运算符后面跟 bool 修饰符来使得返回值 0 和 1，而不是过滤。</p>
<p>标量与标量之间，必须跟 bool 修饰符，因此结果只可能是 0（false） 或 1（true）。<br>向量与标量之间，相当于把向量里的每一个标量跟标量进行比较，结果 为真则保留，否则丢弃。<br>如果后面跟了 bool 修饰符，则结果分别为 1 和 0。</p>
<p>向量与向量之间，运算过程类似于算术类操作符，只不过 如果比较结果 为真则保留左边的值（包括度量指标和标签这些属性），否则丢弃， 没找到匹配也是丢弃。<br>如果后面跟了 bool 修饰符，则保留和丢弃时结果相应为 1 和 0。</p>
<h3 id="逻辑类二元操作符"><a href="#逻辑类二元操作符" class="headerlink" title="逻辑类二元操作符"></a>逻辑类二元操作符</h3><p>逻辑操作符仅用于 向量与向量之间。</p>
<ul>
<li>and：交集</li>
<li>or：合集</li>
<li>unless：补集</li>
</ul>
<p>具体运算规则如下：<br>vector1 and vector2 的结果<br>由在 vector2 里有匹配（标签键值对组合相同）元素的 vector1 里的元素组成。</p>
<p>vector1 or vector2 的结果<br>由所有 vector1 里的元素加上在 vector1 里没有匹配（标签键值对组合相同）元素的  vector2 里的元素组成。</p>
<p>vector1 unless vector2 的结果<br>由在 vector2 里没有匹配（标签键值对组合相同）元素的 vector1 里的元素组成。</p>
<h3 id="二元操作符优先级"><a href="#二元操作符优先级" class="headerlink" title="二元操作符优先级"></a>二元操作符优先级</h3><p>PromQL 的各类二元操作符运算优先级如下：</p>
<ul>
<li>^</li>
<li>*, /, %</li>
<li>+, -</li>
<li>==, !=, &lt;=, &lt;, &gt;=, &gt;</li>
<li>and, unless</li>
<li>or</li>
</ul>
<h3 id="向量匹配"><a href="#向量匹配" class="headerlink" title="向量匹配"></a>向量匹配</h3><p>前面算术类和比较类操作符都需要在向量之间进行匹配。 共有两种匹配类型，one-to-one 和 many-to-one / one-to-many。</p>
<h3 id="One-to-one-向量匹配"><a href="#One-to-one-向量匹配" class="headerlink" title="One-to-one 向量匹配"></a>One-to-one 向量匹配</h3><p>这种匹配模式下，两边向量里的元素如果其标签键值对组合相同则为匹配，并且 只会有一个匹配 元素。可以使用 ignoring 关键词来忽略不参与匹配的标签，或者使用 on 关键词来指定要参与匹配的标签。语法如下：</p>
<p><vector expr> <bin-op> ignoring(<label list>) <vector expr></vector></label></bin-op></vector></p>
<p><vector expr> <bin-op> on(<label list>) <vector expr></vector></label></bin-op></vector></p>
<p>比如对于下面的输入：</p>
<figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">method_code:http_errors:rate5m&#123;method=<span class="hljs-string">"get"</span>, code=<span class="hljs-string">"500"</span>&#125;  24<br>method_code:http_errors:rate5m&#123;method=<span class="hljs-string">"get"</span>, code=<span class="hljs-string">"404"</span>&#125;  30<br>method_code:http_errors:rate5m&#123;method=<span class="hljs-string">"put"</span>, code=<span class="hljs-string">"501"</span>&#125;  3<br>method_code:http_errors:rate5m&#123;method=<span class="hljs-string">"post"</span>, code=<span class="hljs-string">"500"</span>&#125; 6<br>method_code:http_errors:rate5m&#123;method=<span class="hljs-string">"post"</span>, code=<span class="hljs-string">"404"</span>&#125; 21<br><br>method:http_requests:rate5m&#123;method=<span class="hljs-string">"get"</span>&#125;  600<br>method:http_requests:rate5m&#123;method=<span class="hljs-string">"del"</span>&#125;  34<br>method:http_requests:rate5m&#123;method=<span class="hljs-string">"post"</span>&#125; 120<br></code></pre></td></tr></table></figure>
<p>执行下面的查询：</p>
<figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">method_code:http_errors:rate5m&#123;code=<span class="hljs-string">"500"</span>&#125; / ignoring(code) method:http_requests:rate5m<br></code></pre></td></tr></table></figure>
<p>得到的结果为：</p>
<figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">&#123;method=<span class="hljs-string">"get"</span>&#125;  0.04            //  24 / 600<br>&#123;method=<span class="hljs-string">"post"</span>&#125; 0.05            //   6 / 120<br></code></pre></td></tr></table></figure>
<p>也就是每一种 method 里 code 为 500 的请求数占总数的百分比。由于 method 为 put 和 del 的没有匹配元素所以没有出现在结果里。</p>
<p>Many-to- one / one-to-many 向量匹配<br>这种匹配模式下，某一边会有多个元素跟另一边的元素匹配。这时就需要使用 group_left 或 group_right 组修饰符来指明哪边匹配元素较多，左边多则用 group_left，右边多则用 group_right。其语法如下：</p>
<figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) group_left(&lt;label list&gt;) &lt;vector expr&gt;<br>&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) group_right(&lt;label list&gt;) &lt;vector expr&gt;<br>&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) group_left(&lt;label list&gt;) &lt;vector expr&gt;<br>&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) group_right(&lt;label list&gt;) &lt;vector expr&gt;<br></code></pre></td></tr></table></figure>
<p>组修饰符只适用于算术类和比较类操作符。</p>
<p>对于前面的输入，执行下面的查询：</p>
<figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">method_code:http_errors:rate5m / ignoring(code) group_left method:http_requests:rate5m<br></code></pre></td></tr></table></figure>
<p>将得到下面的结果：</p>
<figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">&#123;method=<span class="hljs-string">"get"</span>, code=<span class="hljs-string">"500"</span>&#125;  0.04            //  24 / 600<br>&#123;method=<span class="hljs-string">"get"</span>, code=<span class="hljs-string">"404"</span>&#125;  0.05            //  30 / 600<br>&#123;method=<span class="hljs-string">"post"</span>, code=<span class="hljs-string">"500"</span>&#125; 0.05            //   6 / 120<br>&#123;method=<span class="hljs-string">"post"</span>, code=<span class="hljs-string">"404"</span>&#125; 0.175           //  21 / 120<br></code></pre></td></tr></table></figure>
<p>也就是每种 method 的每种 code  错误次数占每种 method 请求数的比例。这里匹配的时候 ignoring 了 code，才使得两边可以形成 Many-to- one 形式的匹配。 由于左边多，所以需要使用 group_left 来指明。</p>
<p>Many-to- one / one-to-many 过于高级和复杂，要尽量避免使用。很多时候通过 ignoring 就可以解决问题。</p>
<h3 id="聚合操作符"><a href="#聚合操作符" class="headerlink" title="聚合操作符"></a>聚合操作符</h3><p>PromQL 的聚合操作符用来将向量里的元素聚合得 更少。总共有下面这些聚合操作符：</p>
<ul>
<li>sum：求和</li>
<li>min：最小值</li>
<li>max：最大值</li>
<li>avg：平均值</li>
<li>stddev：标准差</li>
<li>stdvar：方差</li>
<li>count： 元素个数</li>
<li>count_values：等于某值的元素个数</li>
<li>bottomk：最小的 k 个元素</li>
<li>topk：最大的 k 个元素</li>
<li>quantile：分位数</li>
</ul>
<p>聚合操作符语法如下：</p>
<p><aggr-op>([parameter,] <vector expression>) [without|by (<label list>)]<br>其中 without 用来指定不需要保留的标签（也就是这些标签的多个值会被聚合），而 by 正好相反，用来指定需要保留的标签（也就是按这些标签来聚合）。</label></vector></aggr-op></p>
<p>下面来看几个示例：</p>
<figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sum(http_requests_total) without (instance)<br></code></pre></td></tr></table></figure>
<p>http_requests_total 度量指标带有 application、instance  和 group 三个标签。上面的表达式会得到每个 application 的 每个 group 在所有 instance 上的请求总数。 效果等同于下面的表达式：</p>
<figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sum(http_requests_total) by (application, group)<br></code></pre></td></tr></table></figure>
<p>下面的表达式可以得到所有 application 的所有 group 的所有 instance 的请求总数。</p>
<figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sum(http_requests_total)<br></code></pre></td></tr></table></figure>
<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><p>Prometheus 内置了一些函数来辅助计算，下面介绍一些典型的，完整的列表请参考 官方文档。</p>
<ul>
<li>abs()：绝对值</li>
<li>sqrt()：平方根</li>
<li>exp()：指数计算</li>
<li>ln()：自然对数</li>
<li>ceil()：向上取整</li>
<li>floor()：向下 取整</li>
<li>round()：四舍五入取整</li>
<li>delta()：计算区间向量里每一个时序第一个和最后一个的差值</li>
<li>sort()：排序</li>
</ul>

    </main>
    <footer class="post-footer">
      
    </footer>
  </article>
  
  
  <nav class="page-nav">
    <div class="page-nav-next page-nav-item">
      
      <a href="/2019/03/22/Docker/1.4 Docker 网络配置/" rel="next" title="Docker 网络配置"><i class="fas fa-angle-left"></i><span class="nav-title">Docker 网络配置</span></a>
      
    </div>
    <div class="page-nav-prev page-nav-item">
      
      <a href="/2019/03/22/Docker/1.1 Docker 简介与安装/" rel="prev" title><span class="nav-title"></span><i class="fas fa-angle-right"></i></a>
      
    </div>
  </nav>
  
  
</div>

          </div>
          
          
          
<aside class="sidebar" id="sidebar" style="background: url(/images/background.png);">
  
  <div class="search">
    <div class="form-group">
      <i class="fas fa-search"></i><input type="search" id="search-input" name="q" results="0" placeholder="搜索" class="form-control">
    </div>
  </div>
  <div class="search-result-box" id="search-result"></div>
  
  
<div class="info sidebar-item" id="info">
  
  <img class="author-avatar" src="/images/avatar.png" alt="Chris">
  
  <h1 class="author-name">Chris</h1>
  <h2 class="author-description"></h2>
  <div class="site-count">
    
    
    
    
    <div class="archives-count count-block">
      <div class="site-count-title">归档</div>
      <div><a href="/archives/">12</a></div>
    </div>
    
    
    
    <div class="categories-count count-block">
      <div class="site-count-title">分类</div>
      <div><a href="/categories/">8</a></div>
    </div>
    
    
    
    <div class="tags-count count-block">
      <div class="site-count-title">标签</div>
      <div><a href="/tags/">0</a></div>
    </div>
    
    
    
    
  </div>
  
  <div class="rss">
    <a class="rss-link button sidebar-item" href="/atom.xml"><i class="fas fa-rss"></i>RSS</a>
  </div>
  
</div>


  <div class="sidebar-sticky">
    
    
    
    
    
    <hr>
    <div class="post-toc sidebar-item" id="toc-div">
      <div><i class="fas fa-list-ol"></i>文章目录</div>
      <div class="post-toc-content"><ol class="list-group toc"><li class="toc-item toc-level-2"><a class="list-group-item toc-link" href="#PromQL-语法"><span class="toc-text">PromQL 语法</span></a></li><li class="toc-item toc-level-2"><a class="list-group-item toc-link" href="#数据类型"><span class="toc-text">数据类型</span></a><ol class="list-group toc-child"><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#瞬时向量-Instant-vector"><span class="toc-text">瞬时向量 (Instant vector):</span></a></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#时序选择器"><span class="toc-text">时序选择器</span></a></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#瞬时向量选择器"><span class="toc-text">瞬时向量选择器</span></a></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#区间向量选择器"><span class="toc-text">区间向量选择器</span></a></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#偏移修饰器"><span class="toc-text">偏移修饰器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="list-group-item toc-link" href="#PromQL-操作符"><span class="toc-text">PromQL 操作符</span></a><ol class="list-group toc-child"><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#二元操作符"><span class="toc-text">二元操作符</span></a></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#算术类二元操作符"><span class="toc-text">算术类二元操作符</span></a></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#比较类二元操作符"><span class="toc-text">比较类二元操作符</span></a></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#逻辑类二元操作符"><span class="toc-text">逻辑类二元操作符</span></a></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#二元操作符优先级"><span class="toc-text">二元操作符优先级</span></a></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#向量匹配"><span class="toc-text">向量匹配</span></a></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#One-to-one-向量匹配"><span class="toc-text">One-to-one 向量匹配</span></a></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#聚合操作符"><span class="toc-text">聚合操作符</span></a></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#函数"><span class="toc-text">函数</span></a></li></ol></li></ol></div>
    </div>
    
    
    
    <hr>
    <div class="social-link sidebar-item">
      <div><i class="far fa-address-card"></i>社交链接<p></p></div>
      <ul>
        
        <li><i class="fas fa-envelope"></i><a href="mailto:youremail@youremailhost" target="_blank">E-Mail</a></li>
        
        <li><i class="fab fa-github"></i><a href="https://github.com/" target="_blank">GitHub</a></li>
        
        <li><i class="fab fa-weibo"></i><a href="https://weibo.com/" target="_blank">Weibo</a></li>
        
      </ul>
    </div>
    
    
    <hr>
    <div class="blogroll sidebar-item">
      <div><i class="fas fa-link"></i>友情链接</div>
      <ul>
        
        <li><i class="fas fa-link"></i><a href="https://github.com/" target="_blank">GitHub</a></li>
        
        <li><i class="fas fa-link"></i><a href="https://developer.mozilla.org/" target="_blank">MDN</a></li>
        
        <li><i class="fas fa-link"></i><a href="https://mozilla.github.io/nunjucks/" target="_blank">Nunjucks</a></li>
        
      </ul>
    </div>
    
  </div>
</aside>


          
        </div>
      </div>
    </main>
    
<footer id="footer" class="footer" style="background: #33363b;">
  <div class="container">
    <div class="back-to-top">
      <button id="back-to-top"><i class="fas fa-angle-double-up" aria-label="回到顶部"></i></button>
    </div>
    <div class="footer-container">
      <div class="footer-left">
        <div class="copyright">
          <span class="author">Chris</span><span class="year"><i class="far fa-copyright"></i>2019</span>
        </div>
        
        <div class="busuanzi">
          <span id="busuanzi_container_site_pv"><i class="fas fa-eye" aria-label="站点点击量" aria-hidden="false"></i><span id="busuanzi_value_site_pv"></span></span><span id="busuanzi_container_site_uv"><i class="fas fa-user" aria-label="站点用户数" aria-hidden="false"></i><span id="busuanzi_value_site_uv"></span></span><span id="busuanzi_container_page_pv"><i class="far fa-file-alt"></i><span id="busuanzi_value_page_pv" aria-label="页面点击量" aria-hidden="false"></span></span>
        </div>
        
      </div>
      <div class="footer-right">
        <div class="custom-info">
          
          托管于<i class="fab fa-github-alt"></i><a href="https://pages.github.com/" target="_blank">GitHub Pages</a>
          
        </div>
        <div class="powered-by">
          由 <a href="https://hexo.io/" target="_blank">Hexo</a> 强力驱动 | 主题 <a href="https://github.com/AlynxZhou/hexo-theme-aria/" target="_blank">ARIA</a>
        </div>
      </div>
    </div>
  </div>
</footer>


  </body>
</html>
